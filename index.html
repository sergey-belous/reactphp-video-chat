<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Group Video Call</title>
    <style>
        #videos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }
        video {
            width: 100%;
            background: #000;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    chromium-browser --unsafely-treat-insecure-origin-as-secure="http://176.98.176.46" --user-data-dir=/tmp/example
    <div id="videos"></div>

    <script>
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        const peerConnections = {};
        let localStream;
        let socket;
        let roomId = 'room1';
        let userId = Math.random().toString(36).substring(2, 10);

        async function init() {
                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                // Create local video element
                const localVideo = document.createElement('video');
                localVideo.muted = true;
                localVideo.autoplay = true;
                localVideo.srcObject = localStream;
                document.getElementById('videos').appendChild(localVideo);
                
                // Connect to signaling server
                socket = new WebSocket('wss://176.98.176.46/ws/');
                socket.onmessage = handleMessage;
                
                // Join the room
                socket.onopen = () => {
                    console.log('Opened connection');
                    socket.send(JSON.stringify({
                        type: 'join-request',
                        room: roomId,
                        userId: userId
                    }));
                }
        }

        function handleMessage(event) {
            const message = JSON.parse(event.data);
            console.log(message);
            switch (message.type) {
                case 'initial-peers':
                    message.peers.forEach(peerId => {
                        if (peerId !== userId && !peerConnections[peerId]) {
                            createPeerConnection(peerId);
                        }
                    });
                    break;
                case 'user-joined':
                    createPeerConnection(message.userId);
                    // Здесь не должно быть подключения!
                    // alert(`${message.userId} joined the room`);
                    // Можно отобразить info о новом участнике, но НЕ запускать createPeerConnection
                    break;
                    
                case 'offer':
                    handleOffer(message);
                    break;
                    
                case 'answer':
                    handleAnswer(message);
                    break;
                    
                case 'candidate':
                    handleCandidate(message);
                    break;
                    
                case 'user-left':
                    removeVideo(message.userId);
                    break;
            }
        }

        function createPeerConnection(targetUserId) {
            let pc;
            if (peerConnections[targetUserId]) {
                pc = peerConnections[targetUserId]; // Не создавать второй раз
            } else {
                pc = new RTCPeerConnection(config);

                pc.onicecandidate = event => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({
                            type: 'candidate',
                            room: roomId,
                            target: targetUserId,
                            userId: userId,
                            data: event.candidate
                        }));
                    }
                };

                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });

                // Handle remote stream
                pc.ontrack = event => {
                    console.log('video event', event);
                    const remoteVideo = document.createElement('video');
                    remoteVideo.id = `video-${targetUserId}`;
                    remoteVideo.autoplay = true;
                    remoteVideo.srcObject = event.streams[0];
                    document.getElementById('videos').appendChild(remoteVideo);
                };
            }
            
            peerConnections[targetUserId] = pc;
            
            // Add local stream
            
            
            // Create offer
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'offer',
                        room: roomId,
                        target: targetUserId,
                        userId: userId,
                        data: pc.localDescription
                    }));
                });
        }

        function handleOffer(message) {
            let pc;
            if (peerConnections[message.sender]) {
                pc = peerConnections[message.sender]; // Не создавать второй раз
            } else {
                pc = new RTCPeerConnection(config);

                pc.onicecandidate = event => {
                    if (event.candidate) {
                        console.log('candidate event', event, message);
                        socket.send(JSON.stringify({
                            type: 'candidate',
                            room: roomId,
                            target: message.sender,
                            userId: userId,
                            data: event.candidate
                        }));
                    }
                };

                pc.ontrack = event => {
                    console.log('offer event', event, message);
                    const remoteVideo = document.createElement('video');
                    remoteVideo.id = `video-${message.sender}`;
                    remoteVideo.autoplay = true;
                    remoteVideo.srcObject = event.streams[0];
                    document.getElementById('videos').appendChild(remoteVideo);
                };
            };
            
            peerConnections[message.sender] = pc;
            
            pc.setRemoteDescription(new RTCSessionDescription(message.data))
                .then(() => pc.createAnswer())
                .then(answer => pc.setLocalDescription(answer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        room: roomId,
                        target: message.sender,
                        userId: userId,
                        data: pc.localDescription
                    }));
                });
        }

        function handleAnswer(message) {
            const pc = peerConnections[message.sender];
            if (pc) {
                pc.setRemoteDescription(new RTCSessionDescription(message.data));
            }
        }

        function handleCandidate(message) {
            const pc = peerConnections[message.sender];
            if (pc) {
                pc.addIceCandidate(new RTCIceCandidate(message.data));
            }
        }

        function removeVideo(userId) {
            const video = document.getElementById(`video-${userId}`);
            if (video) video.remove();
            
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
        }

        // Start on page load
        window.onload = init;
    </script>
</body>
</html>
